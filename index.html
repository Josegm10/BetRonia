<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Djokovic Challenge - Admin Table Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #004d3d; --accent: #c1ff00; --bg: #f0f4f2; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; border: 2px solid var(--primary); width: 100%; max-width: 500px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h3, h4 { color: var(--primary); text-transform: uppercase; margin: 10px 0; }
        input, button, textarea { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
        
        /* TABLA JUGADOR */
        .info-box { background: #fffde7; border: 2px dashed #fbc02d; padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        .stats-table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        .stats-table th { background: #fbc02d; padding: 5px; border: 1px solid #eab308; }
        .stats-table td { padding: 5px; border: 1px solid #eee; text-align: center; }
        .am { background: #ffeb3b; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
        .ro { background: #f44336; color: white; font-weight: bold; padding: 2px 4px; border-radius: 3px; }

        /* ADMIN CONTROL */
        .admin-section { background: #f1f5f9; padding: 15px; border-radius: 10px; text-align: left; margin-bottom: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .row-edit { display: flex; justify-content: space-between; align-items: center; background: white; padding: 5px 10px; margin-top: 5px; border-radius: 5px; font-size: 12px; border: 1px solid #ddd; }
        .btn-edit { background: #22c55e; width: auto; padding: 5px 10px; font-size: 10px; }
        .btn-del { background: #ef4444; width: auto; padding: 5px 10px; font-size: 10px; }
    </style>
</head>
<body>

    <div id="admin-ui" class="card hidden">
        <h3>üõ†Ô∏è GESTI√ìN DE ESTAD√çSTICAS</h3>
        
        <div class="admin-section">
            <h4>Modificar Tabla de Jugadores</h4>
            <input type="text" id="in-jug" placeholder="Nombre (Ej: Vinicius)">
            <input type="text" id="in-pos" placeholder="Posici√≥n (DEL, MED...)">
            <div class="grid-3">
                <input type="number" id="in-gol" placeholder="Goles">
                <input type="number" id="in-ama" placeholder="Amarillas">
                <input type="number" id="in-roj" placeholder="Rojas">
            </div>
            <button onclick="guardarDato()" id="btn-main-action">A√ëADIR / ACTUALIZAR</button>
            
            <div id="admin-table-list" style="margin-top:15px;">
                </div>
        </div>

        <div class="admin-section">
            <h4>Control de Categor√≠as</h4>
            <textarea id="adm-o2" placeholder="Opciones 2pts (comas)"></textarea>
            <textarea id="adm-o3" placeholder="Opciones 3pts (comas)"></textarea>
            <button onclick="lanzarRonda()">Lanzar Nueva Ronda</button>
        </div>
        <button onclick="location.reload()" style="background:#666">Salir Modo Admin</button>
    </div>

    <div id="game-ui" class="card">
        <img src="https://i.postimg.cc/FzXJKQQQ/Captura-de-pantalla-2026-02-02-113118.png" style="width:100%; border-radius:10px;">
        <h3 id="user-display">Invitado</h3>

        <div class="info-box">
            <h4>üìä ESTAD√çSTICAS JUGADORES</h4>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th rowspan="2">JUGADOR</th>
                        <th rowspan="2">POS.</th>
                        <th rowspan="2">GOLES</th>
                        <th colspan="2">TARJETAS</th>
                    </tr>
                    <tr>
                        <th>AM</th>
                        <th>RO</th>
                    </tr>
                </thead>
                <tbody id="stats-body"></tbody>
            </table>
        </div>

        <div id="voting-area" style="text-align:left;">
            <h4>üéØ 2 Puntos:</h4><div id="opt-2"></div>
            <h4>üî• 3 Puntos:</h4><div id="opt-3"></div>
            <button id="btn-votar" onclick="votar()" class="hidden" style="margin-top:10px;">ENVIAR VOTOS</button>
        </div>
        
        <button onclick="accesoAdmin()" style="background:none; color:#ccc; font-size:10px; margin-top:20px;">Admin</button>
    </div>

    <script>
        const SB_URL = 'https://jvjzqodxumblrkiisfva.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2anpxb2R4dW1ibHJraWlzZnZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NjY2ODUsImV4cCI6MjA4NTU0MjY4NX0.Y65rnPUEsIkiBZOx1WL2M4ukSr_kDsAq6quyfLOBMCU';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let esAdmin = false;

        // --- FUNCIONES ADMIN PARA MODIFICAR TABLA ---
        async function guardarDato() {
            const jug = document.getElementById('in-jug').value;
            const pos = document.getElementById('in-pos').value;
            const gol = document.getElementById('in-gol').value || 0;
            const ama = document.getElementById('in-ama').value || 0;
            const roj = document.getElementById('in-roj').value || 0;

            if(!jug) return alert("Nombre necesario");

            await sb.from('estadisticas').upsert({ 
                sujeto: jug, dato1: pos, dato2: gol, dato3: ama, dato4: roj 
            }, { onConflict: 'sujeto' });

            limpiarForm();
        }

        function prepararEdicion(j, p, g, a, r) {
            document.getElementById('in-jug').value = j;
            document.getElementById('in-pos').value = p;
            document.getElementById('in-gol').value = g;
            document.getElementById('in-ama').value = a;
            document.getElementById('in-roj').value = r;
            document.getElementById('in-jug').focus();
        }

        async function borrarDato(jug) {
            if(confirm(`¬øEliminar a ${jug}?`)) await sb.from('estadisticas').delete().eq('sujeto', jug);
        }

        function limpiarForm() {
            document.querySelectorAll('.admin-section input').forEach(i => i.value = "");
        }

        function accesoAdmin() {
            if(prompt("Clave:") === "1234") {
                esAdmin = true;
                document.getElementById('admin-ui').classList.remove('hidden');
                document.getElementById('game-ui').classList.add('hidden');
                refrescar();
            }
        }

        // --- REFRESCAR DATOS (REALTIME) ---
        async function refrescar() {
            const { data: st } = await sb.from('estadisticas').select('*').order('sujeto');
            const { data: jg } = await sb.from('estado_juego').select('*').single();

            // Llenar tabla p√∫blica
            document.getElementById('stats-body').innerHTML = st.map(s => `
                <tr>
                    <td style="text-align:left; font-weight:bold;">${s.sujeto}</td>
                    <td>${s.dato1}</td>
                    <td><b>${s.dato2}</b></td>
                    <td><span class="am">${s.dato3}</span></td>
                    <td><span class="ro">${s.dato4}</span></td>
                </tr>`).join('');

            // Llenar lista de edici√≥n en Admin
            if(esAdmin) {
                document.getElementById('admin-table-list').innerHTML = st.map(s => `
                    <div class="row-edit">
                        <span><b>${s.sujeto}</b> (${s.dato1})</span>
                        <div>
                            <button class="btn-edit" onclick="prepararEdicion('${s.sujeto}','${s.dato1}','${s.dato2}','${s.dato3}','${s.dato4}')">‚úé</button>
                            <button class="btn-del" onclick="borrarDato('${s.sujeto}')">X</button>
                        </div>
                    </div>`).join('');
            }
        }

        async function lanzarRonda() {
            const o2 = document.getElementById('adm-o2').value.split(',').map(x=>x.trim());
            const o3 = document.getElementById('adm-o3').value.split(',').map(x=>x.trim());
            await sb.from('estado_juego').update({ opciones2: o2, opciones3: o3 }).eq('id', 1);
            alert("Ronda actualizada");
        }

        // Suscripci√≥n Realtime
        sb.channel('db').on('postgres_changes', { event: '*', schema: 'public' }, () => refrescar()).subscribe();
        refrescar();
    </script>
</body>
</html>

